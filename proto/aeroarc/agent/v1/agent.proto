syntax = "proto3";

package aeroarc.agent.v1;

option go_package = "github.com/aero-arc/aero-arc-protos/gen/go/aeroarc/agent/v1;agentv1";

// Agent â†’ Relay RPC API
service AgentGateway {
  // Initial connection handshake.
  rpc Register(RegisterRequest) returns (RegisterResponse);

  // Bidirectional telemetry streaming.
  rpc TelemetryStream(stream TelemetryFrame)
      returns (stream TelemetryAck);
}

// ----- Registration -----

message RegisterRequest {
  string agent_id      = 1;

  string agent_version = 2;
  string platform      = 3; // e.g. "linux/arm64"
}

message RegisterResponse {
  string agent_id    = 1;
  string session_id  = 3;

  int64  max_inflight = 4; // recommended unacked frames in flight
}

// ----- Telemetry -----

message TelemetryFrame {
  string session_id = 1; // server-issued session ID from RegisterResponse
  string agent_id   = 2;

  uint64 seq        = 3; // monotonically increasing sequence number

  int64  sent_at_unix_ns   = 4;
  double device_timestamp_sec = 5;

  bytes  raw_mavlink       = 6;
  string dialect           = 7;
  uint32 msg_id            = 8;
  string msg_name          = 9;

  // Parsed MAVLink fields as stringified key/value pairs.
  // Not guaranteed to preserve original types.
  map<string, string> fields = 10;

  // Optional: client-defined flight grouping
  string flight_id = 11;
}

message TelemetryAck {
  string relay_id = 1;
  uint64 seq = 2;

  enum Status {
    STATUS_OK              = 0;
    STATUS_TEMPORARY_ERROR = 1;
    STATUS_PERMANENT_ERROR = 2;
    STATUS_RETRY_WITH_BACKOFF = 3;
  }

  Status status = 3;
  string error  = 4;
}
